# ============================================
# Nginx - Arc Spatial Project for Next.js Production
# ==============================================
# Note:
# Replace to all domain arcspatial.portaltestnet.com by u own https://your-domain.com
# Next.js will be running on localhost:3000 (replace port your own)
# Setup:
#   1. Copy file nano /etc/nginx/sites-available/arcspatial
#   2. ln -s /etc/nginx/sites-available/arcspatial /etc/nginx/sites-enabled/
#   3. nginx -t && systemctl reload nginx
#
# ============================================

# WebSocket upgrade map - required for Socket.IO
# Only set Connection to "upgrade" when the request is a WebSocket upgrade
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Main Server - arcspatial.portaltestnet.com
server {
    listen 80;
    server_name arcspatial.portaltestnet.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name arcspatial.portaltestnet.com;

    # SSL Certificate same main domain
    ssl_certificate /etc/ssl/portaltestnet/certificate.pem;
    ssl_certificate_key /etc/ssl/portaltestnet/private.key;
    
    include snippets/ssl-params.conf;
    client_max_body_size 100M;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Block sensitive paths
    location ~* (\.env|\.git|wp-|admin|config\.php) {
        deny all;
        return 403;
    }

    # Next.js Static Files - Cached
    location /_next/static {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        
        # Cache static files for 1 year (immutable)
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Public static files
    location /public {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        # Cache for 1H
        add_header Cache-Control "public, max-age=3600";
    }

    # API Routes - No cache, with longer timeout for AI
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        # timeout for AI agent responses
        proxy_read_timeout 120s;
        proxy_send_timeout 120s;
        proxy_connect_timeout 60s;
        # SSE Disable buffering
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
        # No cache for API
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        add_header Pragma "no-cache";
        add_header X-Accel-Buffering "no";
    }

    # WebSocket Server Health Check - shows real-time server status
    # Returns full simulation state: fleet, tasks, objects, zones, metrics
    location = /ws-health {
        proxy_pass http://localhost:3003/api/status;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        add_header Cache-Control "no-store" always;
    }

    # Socket.IO WebSocket (simulation server on port 3003)
    # IMPORTANT: Do NOT add URI path to proxy_pass â€” let nginx pass the full original path
    # This ensures query params like ?EIO=4&transport=polling are preserved correctly
    location /socket.io/ {
        proxy_pass http://localhost:3003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_buffering off;
    }

    # Main application - No cache for HTML
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        # No cache for dynamic content
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache";
        add_header Expires 0;
    }

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;
}
